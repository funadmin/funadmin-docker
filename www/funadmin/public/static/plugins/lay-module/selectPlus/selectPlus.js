layui.define("form",function(exports){var $=layui.$,form=layui.form,hint=layui.hint(),MOD_NAME="selectPlus",SELECT="layui-form-select",SELECTED="layui-form-selected",selectPlus={index:layui.selectPlus?layui.selectPlus.index:0,set:function(options){var that=this;that.config=$.extend({},that.config,options);return that},on:function(events,callback){return layui.onevent.call(this,MOD_NAME,events,callback)}},thisIns=function(){var that=this,options=that.config;return{getChecked:function(){return that.getChecked.call(that)},config:options}},Class=function(options){var that=this;that.index=++selectPlus.index;if(options.field.length===1){delete options.field}that.config=$.extend({},that.config,selectPlus.config,options);that.render()};Class.prototype.config={type:"checkbox",delimiter:",",fielddelimiter:"  ---  ",placeholder:"请选择",data:[],name:"name",field:["id","title"],values:[],titles:[],url:"",method:"get",where:"",contentType:"",headers:"",response:"data",parseData:null,config:{checkedName:"SELECTPLUS_CHECKED",indexName:"SELECTPLUS_INDEX"},error:""};Class.prototype.render=function(){var that=this,options=that.config;typeof options.el==="string"?options.el=$(options.el):options.el;options.reElem=$('<div class="layui-unselect layui-form-select">'+'<div class="layui-select-title">'+'<input type="hidden" name="'+options.name+'"><input type="text" placeholder="'+options.placeholder+'" value="" readonly="" class="layui-input layui-unselect">'+'<i class="layui-edge"></i>'+"</div>"+'<dl class="layui-anim layui-anim-upbit">'+'<dd lay-value="" class="layui-select-tips layui-hide">'+options.placeholder+"</dd>"+"</dl>"+"</div>");options.reElem.find(".layui-select-title").on("click",function(e){!$(this).parent().hasClass(SELECTED)?$(document).find("."+SELECT).removeClass(SELECTED):"";$(this).parent().toggleClass(SELECTED)});$(document).on("click",function(e){$(e.target).parents("."+SELECT).length<=0&&options.reElem.hasClass(SELECTED)?options.reElem.removeClass(SELECTED):""});!Array.isArray(options.values)?options.values=[options.values]:"";options.filter=options.el.parents(".layui-form").attr("lay-filter");options.el.html(options.reElem);if(options.url){this.pullData()}else{that.renderData()}options.el.on("click",".layui-select-title",function(){var $title=$(this),$dd0=$title.next().find("dd").eq(0);if(!$dd0.hasClass("layui-hide")){$dd0.addClass("layui-hide")}$title.find('input[name="+options.name+"]').val(options.values.join(options.delimiter));$title.find('input[type="text"]').val(options.titles.join(options.delimiter))})};Class.prototype.pullData=function(){var that=this,options=that.config;$.ajax({type:options.method||"get",url:options.url,contentType:options.contentType,data:options.where||{},dataType:"json",async:true,headers:options.headers||{},success:function(res){if(typeof options.parseData==="function"){res=options.parseData(res)||res[options.response]}if(res.code>0&&(typeof res.data==="object"||Array.isArray(res.data))){that.config.data=options.data=that.formatData(res.data);options.error="";that.renderData()}else{options.error="数据格式不对"}},error:function(e,m){options.error="数据接口请求异常："+m}})};Class.prototype.formatData=function(data){var that=this,options=that.config,field=options.field,values=options.values,checkedName=options.config.checkedName,indexName=options.config.indexName;var k=0;var formData=[];layui.each(data,function(i,item){if(typeof item!=="object"){formData[k]={title:__(item),id:i}}else{formData[k]=item}formData[k][indexName]=k;if(!data[i][checkedName])formData[k][checkedName]=false;layui.each(values,function(index,value){if(formData[k][field[0]]==value){formData[k][checkedName]=true}});k++});values.splice(0);that.config.data=formData;return formData};Class.prototype.renderData=function(data){var that=this,options=that.config,type=options.type,id=that.index,data=data?that.formatData(data):that.formatData(options.data);items={checkbox:function(config,data,id){var CLASSNAME="layui-form-checkbox",CHECKED="layui-form-checked",el=config.reElem.find("dl"),checkedName=config.config.checkedName,indexName=config.config.indexName,values=config.values,field=config.field,filter=config.filter,fielddelimiter=config.fielddelimiter,delimiter=config.delimiter,sum=0;el.append($('<dd lay-value="全选"></dd>'));layui.each(data,function(i,item){el.append($('<dd lay-value="'+item[field[0]]+'"></dd>'))});var allEle=el.find("dd").eq(1);var check_title=[];allEle.nextAll().each(function(index){var $dd=$(this),item=data[index],title=titletemp=item[field[1]],value=item[field[0]];if(field.length>0){title="";layui.each(field,function(i,n){title+=item[n];i<field.length-1?title+=fielddelimiter:""})}var checkbox=$('<input  type="checkbox" name="'+MOD_NAME+"checkbox"+id+'"  ff-index="'+item[indexName]+'" lay-skin="primary" title="'+title+'" layui-value="'+value+'">');if(item[checkedName]){checkbox.prop("checked",true);values.push(value);check_title.push(titletemp);sum++}$dd.html(checkbox)});var allcheckbox=$('<input  type="checkbox"  selectplus-all  lay-skin="primary" title="全选" layui-value="全选">');sum===data.length?allcheckbox.prop("checked",true):"";allEle.html(allcheckbox);allEle.parent().prev().find('input[name="'+config.name+'"]').val(values.join(delimiter));allEle.parent().prev().find('input[type="text"]').val(check_title.join(delimiter));allEle.on("click",function(event){var $all=$(this),checked=event.target.nodeName==="DD"?$all.find("."+CLASSNAME).toggleClass(CHECKED).hasClass(CHECKED):$all.find("input").prop("checked");$all.parents("."+SELECT).addClass(SELECTED);$all.find("input").prop("checked",checked);$all.nextAll().each(function(){var dd=$(this);checked?dd.find("."+CLASSNAME).addClass(CHECKED):dd.find("."+CLASSNAME).removeClass(CHECKED);dd.find("input").prop("checked",checked)});layui.event.call($all,MOD_NAME,"checkbox"+"("+MOD_NAME+")"+that.index,{type:"checkbox",ele:$all,eleChecked:checked,isAll:checked});return false});allEle.nextAll().on("click",function(event){var $dd=$(this),checked=event.target.nodeName==="DD"?$dd.find("."+CLASSNAME).toggleClass(CHECKED).hasClass(CHECKED):$dd.find("input").prop("checked");$dd.parents("."+SELECT).addClass(SELECTED);$dd.find("input").prop("checked",checked);var $all=$dd.parents("dl").find("dd").eq(1),$dds=$all.nextAll(),sum=0;$dds.each(function(){$(this).find("input").prop("checked")?sum++:""});if(sum===$dds.length){$all.find("input").prop("checked",true);$all.find("."+CLASSNAME).addClass(CHECKED)}else{$all.find("input").prop("checked",false);$all.find("."+CLASSNAME).removeClass(CHECKED)}layui.event.call($all,MOD_NAME,"checkbox"+"("+MOD_NAME+")"+that.index,{type:"checkbox",ele:$dd,eleChecked:checked,isAll:sum===$dds.length});return false});form.render("checkbox",filter)},radio:function(config,data,id){var CLASSNAME="layui-form-radio",CHECKED="layui-form-radioed",ICON=["&#xe643;","&#xe63f;"],CHECKED_ICON="layui-anim-scaleSpring",elID=config.el,el=config.reElem.find("dl"),checkedName=config.config.checkedName,indexName=config.config.indexName,checkedData=data.filter(function(item){return item[checkedName]===true}),values=config.values,field=config.field,filter=config.filter,fielddelimiter=config.fielddelimiter,delimiter=config.delimiter;layui.each(data,function(i,item){el.append('<dd lay-value="'+item[field[0]]+'"></dd>')});form.render("select",options.filter);var check_title=[];el.find("dd").eq(0).nextAll().each(function(index){var $dd=$(this),item=data[index],title=titletemp=item[field[1]],value=item[field[0]];if(field.length>0){title="";layui.each(field,function(i,n){title+=item[n];i<field.length-1?title+=fielddelimiter:""})};var dd=$('<input type="radio" name="'+MOD_NAME+"radio"+id+'"  ff-index="'+item[indexName]+'" lay-skin="primary" title="'+title+'" layui-value="'+value+'">');if(checkedData.length>0&&checkedData[0][indexName]===item[indexName]){dd.prop("checked",true);values.push(value);check_title.push(titletemp);$dd.parent().prev().find('input[name="'+config.name+'"]').val(values.join(delimiter));$dd.parent().prev().find('input[type="text"]').val(check_title.join(delimiter))}$dd.html(dd)});el.next().find("dl").addClass("ff-selectPlus");form.render("radio",filter);el.find("dd").on("click",function(event){var $dd=$(this);$dd.find("."+CLASSNAME).addClass(CHECKED).find("i").addClass(CHECKED_ICON).html(ICON[0]);$dd.find("input").prop("checked",true);$dd.siblings().find("."+CLASSNAME).removeClass(CHECKED).find("i").removeClass(CHECKED_ICON).html(ICON[1]);$dd.siblings().find("input").prop("checked",false);layui.event.call($dd,MOD_NAME,"radio"+"("+MOD_NAME+")"+that.index,{type:"radio",ele:$dd,eleChecked:true,isAll:false})})}};layui.onevent.call(that,MOD_NAME,type+"("+MOD_NAME+")"+that.index,that.checked.bind(that));items[type]?items[type](options,data,id):hint.error("不支持的"+type+"表单渲染")};Class.prototype.checked=function(res){var that=this,options=that.config,data=options.data,checkedName=options.config.checkedName,type=res.type,isAll=res.isAll,ele=res.ele,eleChecked=res.eleChecked,filter=options.el.attr("lay-filter");if(type==="checkbox"){options.values=[];options.titles=[];ele.parents("dl").find('[type="checkbox"]').each(function(i){var $dd=$(this),ffIndex=$dd.attr("ff-index"),checked=$dd.prop("checked");ffIndex?data[ffIndex][checkedName]=checked:"";checked&&ffIndex?options.values.push($dd.attr("layui-value")):"";checked&&ffIndex?options.titles.push(data[ffIndex][options.field[1]]):""});ele.parent().prev().find('input[type="hidden"]').val(options.values.join(options.delimiter));ele.parent().prev().find('input[type="text"]').val(options.titles.join(options.delimiter));layui.event.call(ele,MOD_NAME,MOD_NAME+"("+filter+")",{checked:eleChecked,isAll:isAll,values:options.values,titles:options.titles,checkedData:data.filter(function(item){return item[checkedName]===true}),ele:ele})}else if(type==="radio"){var index=ele.find("input").attr("ff-index"),value=ele.find("input").attr("layui-value");title=data[index]["title"];options.values=[value];options.titles=[title.split(options.delimiter)[0]];ele.parent().prev().find('input[type="hidden"]').val(value);ele.parent().prev().find('input[type="text"]').val(title);layui.each(data,function(i,item){item[checkedName]=false});data[index][checkedName]=true;layui.event.call(ele,MOD_NAME,MOD_NAME+"("+filter+")",{value:value,title:title,checkedData:data[index],ele:ele})}};Class.prototype.getChecked=function(){var that=this,options=that.config,data=options.data,checkedName=options.config.checkedName;return{values:options.values,data:data.filter(function(item){return item[checkedName]===true})}};selectPlus.render=function(options){var ins=new Class(options);return thisIns.call(ins)};exports("selectPlus",selectPlus)});